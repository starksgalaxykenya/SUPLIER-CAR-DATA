<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CK Manager ¬∑ secure import</title>
    <!-- Firebase compat -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- SheetJS for Excel import -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        body {
            background: #0a0c10;
            display: flex;
            justify-content: center;
            padding: 2rem 1.5rem;
            color: #eef3f8;
        }
        .app-container { max-width: 1440px; width: 100%; }

        .card {
            background: #151a22;
            border-radius: 26px;
            padding: 2rem 2.2rem;
            border: 1px solid #2c3542;
            box-shadow: 0 16px 30px -10px black;
        }

        .tabs {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }
        .tab-btn {
            background: transparent;
            border: 1px solid #384458;
            padding: 0.7rem 2rem;
            border-radius: 40px;
            font-weight: 500;
            color: #b7c9e0;
            cursor: pointer;
            transition: 0.15s;
        }
        .tab-btn.active {
            background: #2c402c;
            border-color: #6fa06f;
            color: #e2f0e2;
        }
        .tab-btn:hover { border-color: #7fa07f; }

        /* hidden import trigger - subtle but accessible */
        .secret-import-trigger {
            display: inline-block;
            cursor: pointer;
            color: #4a5f4a;
            font-size: 1.8rem;
            line-height: 1;
            transition: 0.2s;
            margin-left: 1rem;
        }
        .secret-import-trigger:hover {
            color: #8fbc8f;
            transform: scale(1.05);
        }

        /* modal overlay */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(3px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-card {
            background: #1e262f;
            border-radius: 36px;
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            border: 1px solid #5f8b5f;
            box-shadow: 0 30px 50px #00000080;
        }
        .modal-card h3 {
            color: #c6f0c6;
            margin-bottom: 1.5rem;
            font-weight: 400;
        }
        .modal-card input[type="file"] {
            background: #0f171f;
            border: 1px solid #4e6d5e;
            border-radius: 30px;
            padding: 1rem;
            width: 100%;
            color: white;
            margin: 1rem 0;
        }
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }
        .btn-secret {
            background: #2e452e;
            border: 1px solid #7ba07b;
            color: white;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1.2rem 2rem;
            margin-bottom: 1.6rem;
            align-items: flex-end;
        }
        .field-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
            flex: 1 0 140px;
        }
        .field-group label {
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 500;
            color: #99aac2;
            margin-bottom: 0.25rem;
        }
        .field-group input, .field-group select {
            background: #0f141d;
            border: 1px solid #2e3745;
            border-radius: 16px;
            padding: 0.85rem 1.2rem;
            font-size: 0.95rem;
            color: #f0f7ff;
        }
        .field-group select {
            appearance: none;
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2399b3cc'><polyline points='6 9 12 15 18 9'/></svg>");
            background-repeat: no-repeat;
            background-position: right 1rem center;
        }
        .field-group input:focus, .field-group select:focus {
            border-color: #7dae7d;
            box-shadow: 0 0 0 2px #2a4a2a80;
            outline: none;
        }
        .field-group input[readonly] {
            background: #1b232f;
            color: #cbd6e6;
        }

        .exchange-rate-row {
            background: #1b2620;
            border: 1px solid #3d5841;
            border-radius: 60px;
            padding: 0.8rem 2rem;
            display: flex;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
            margin-bottom: 2.2rem;
        }
        .rate-label { font-weight: 500; color: #bde1bd; }
        .rate-input {
            width: 130px;
            background: #0f1a12;
            border: 1px solid #578057;
            border-radius: 30px;
            padding: 0.6rem 1.2rem;
            color: white;
        }

        .btn {
            background: #262f3b;
            border: 1px solid #43536a;
            padding: 0.8rem 2rem;
            border-radius: 30px;
            font-weight: 500;
            cursor: pointer;
            color: #dde9f5;
            transition: 0.15s;
        }
        .btn-primary {
            background: #2d442d;
            border-color: #70a070;
            color: #f0fff0;
        }
        .btn-primary:hover { background: #3e603e; }
        .btn-outline {
            background: transparent;
            border-color: #527252;
            color: #c6e2c6;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 20px;
            border: 1px solid #2f3847;
            background: #121721;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            min-width: 1300px;
            color: #e5eef7;
        }
        th {
            background: #212b38;
            padding: 1rem 0.8rem;
            font-weight: 500;
            border-bottom: 1px solid #557255;
        }
        td { padding: 0.9rem 0.8rem; border-bottom: 1px solid #28313e; }

        .overview-stats {
            display: flex;
            gap: 2rem;
            background: #1e2a20;
            border: 1px solid #4e6e53;
            border-radius: 48px;
            padding: 1.5rem 2.8rem;
            margin-bottom: 2.5rem;
            flex-wrap: wrap;
        }
        .stat-item {
            background: #121f15;
            border: 1px solid #5b875b;
            border-radius: 40px;
            padding: 0.7rem 2.2rem;
            font-weight: 500;
            color: #daf0da;
        }

        .hidden-tab { display: none; }
        #importFeedback { margin-top: 1rem; color: #b3e0b3; font-size: 0.9rem; }
    </style>
</head>
<body>
<div class="app-container">
    <div style="display: flex; align-items: center; margin-bottom: 2rem;">
        <h2 style="font-weight: 400; color: #eaf3ea;"><span style="color: #9fda9f;">CK</span> manager ¬∑ vehicle finance</h2>
        <!-- secret import trigger (looks like a simple icon) -->
        <span class="secret-import-trigger" id="importTrigger" title="import data (restricted)">‚ö°</span>
    </div>

    <div class="tabs" id="tabNavigation">
        <button class="tab-btn active" data-tab="entry">‚ûï entry</button>
        <button class="tab-btn" data-tab="spreadsheet">üìã spreadsheet</button>
        <button class="tab-btn" data-tab="overview">üìä overview & pdf</button>
    </div>

    <!-- hidden import modal (secure, no visible hints) -->
    <div class="modal" id="importModal">
        <div class="modal-card">
            <h3>üîí secure import</h3>
            <p style="color:#b8d5b8; margin-bottom:1.5rem;">upload excel file (.xlsx) ‚Äî only GOONET sheet data will be mapped</p>
            <input type="file" id="excelFileInput" accept=".xlsx, .xls, .csv">
            <div class="modal-actions">
                <button class="btn btn-outline" id="cancelImport">cancel</button>
                <button class="btn btn-secret" id="confirmImport">import & save to firebase</button>
            </div>
            <div id="importFeedback"></div>
        </div>
    </div>

    <!-- entry tab (unchanged, but SM auto now works with import) -->
    <div id="tab-entry" class="tab-content card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="font-weight: 400; color: #d2f0d2;">new record ¬∑ <span style="font-size:0.9rem;">SM seq WANB‚Äëxx</span></h3>
            <span class="rate-label">‚ö° exchange</span>
        </div>
        <div class="exchange-rate-row">
            <span class="rate-label">üí± rate</span>
            <input type="number" id="exchangeRateInput" class="rate-input" value="132.80" step="0.5" min="0">
        </div>
        <div class="form-row">
            <div class="field-group"><label>Payment rate</label><input type="text" id="paymentRate" value="10.5%"></div>
            <div class="field-group"><label>SM (seq.)</label><input type="text" id="sm" readonly placeholder="WANB-01" value="WANB-01"></div>
            <div class="field-group"><label>Supplier</label>
                <select id="supplier">
                    <option value="GOONET">GOONET</option><option value="ENHANCE">ENHANCE</option><option value="TTC">TTC</option>
                    <option value="OTTOS">OTTOS</option><option value="GLOBAL">GLOBAL</option>
                </select>
            </div>
            <div class="field-group"><label>Make & Model</label><input type="text" id="makeModel" value="Toyota Hilux"></div>
        </div>
        <div class="form-row">
            <div class="field-group"><label>Chassis No</label><input type="text" id="chassis" value="MR0EX3CJ50J123456"></div>
            <div class="field-group"><label>CFR (USD)</label><input type="number" id="cfr" value="25200" step="100"></div>
            <div class="field-group"><label>Paid USD</label><input type="number" id="paidUsd" value="10200" step="100"></div>
            <div class="field-group"><label>Selling Price USD</label><input type="number" id="sellingPrice" value="31500" step="100"></div>
        </div>
        <div class="form-row">
            <div class="field-group"><label>üí∞ Margin USD</label><input type="number" id="marginUsd" readonly></div>
            <div class="field-group"><label>üí∞ Margin KSH</label><input type="number" id="marginKes" readonly></div>
        </div>
        <div style="display: flex; gap: 1.2rem; flex-wrap: wrap;">
            <button class="btn btn-primary" id="calculateBtn">‚ü≤ calculate</button>
            <button class="btn btn-primary" id="saveToFirebaseBtn">üíæ save to firebase</button>
            <button class="btn btn-outline" id="clearFormBtn">clear</button>
        </div>
        <p id="saveFeedback"></p>
    </div>

    <!-- spreadsheet and overview same as before (trimmed for length) -->
    <div id="tab-spreadsheet" class="tab-content card hidden-tab">
        <div class="action-bar"><h3>üìã all records</h3><button class="btn btn-outline" id="refreshSheetBtn">‚Üª refresh</button></div>
        <div class="table-wrapper"><table><thead><tr><th>Pay rate</th><th>SM</th><th>Supplier</th><th>Make/model</th><th>Chassis</th><th>CFR</th><th>Paid USD</th><th>Sell price</th><th>Margin USD</th><th>Margin KES</th></tr></thead><tbody id="sheetBody"><tr><td colspan="10">loading...</td></tr></tbody></table></div>
    </div>

    <div id="tab-overview" class="tab-content card hidden-tab">
        <div class="overview-stats"><div class="stat-item" id="totalVehiclesStat">Total: 0</div><div class="stat-item" id="totalMarginUsdStat">Margin USD: 0</div><div class="stat-item" id="totalMarginKesStat">Margin KES: 0</div></div>
        <div class="print-docs-area"><h3 style="color:#d2f0d2;">üñ®Ô∏è pdf</h3><div style="display:flex; gap:2rem; margin:2rem 0;"><button class="btn btn-primary" id="downloadPdfReport">üì• full report PDF</button><button class="btn btn-outline" id="downloadSnapshotPdf">üì∏ snapshot PDF</button></div><div class="doc-thumb-grid" id="snapshotGrid"></div></div>
    </div>
</div>

<script>
    (function() {
        // firebase init
        const firebaseConfig = {
            apiKey: "AIzaSyCuUKCxYx0jYKqWOQaN82K5zFGlQsKQsK0",
            authDomain: "ck-manager-1abdc.firebaseapp.com",
            projectId: "ck-manager-1abdc",
            storageBucket: "ck-manager-1abdc.firebasestorage.app",
            messagingSenderId: "890017473158",
            appId: "1:890017473158:web:528e1eebc4b67bd54ca707"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const recordsCol = db.collection('vehicleRecords');

        // DOM elements
        const tabs = document.querySelectorAll('.tab-btn');
        const tabEntry = document.getElementById('tab-entry');
        const tabSpread = document.getElementById('tab-spreadsheet');
        const tabOverview = document.getElementById('tab-overview');
        const smField = document.getElementById('sm');
        const supplier = document.getElementById('supplier');
        const paymentRate = document.getElementById('paymentRate');
        const makeModel = document.getElementById('makeModel');
        const chassis = document.getElementById('chassis');
        const cfr = document.getElementById('cfr');
        const paid = document.getElementById('paidUsd');
        const sell = document.getElementById('sellingPrice');
        const marginUsd = document.getElementById('marginUsd');
        const marginKes = document.getElementById('marginKes');
        const exchange = document.getElementById('exchangeRateInput');
        const saveBtn = document.getElementById('saveToFirebaseBtn');
        const clearBtn = document.getElementById('clearFormBtn');
        const calcBtn = document.getElementById('calculateBtn');
        const refreshBtn = document.getElementById('refreshSheetBtn');
        const sheetBody = document.getElementById('sheetBody');
        const snapshotGrid = document.getElementById('snapshotGrid');
        const totalVehiclesSpan = document.getElementById('totalVehiclesStat');
        const totalMarginUsdSpan = document.getElementById('totalMarginUsdStat');
        const totalMarginKesSpan = document.getElementById('totalMarginKesStat');
        const feedback = document.getElementById('saveFeedback');

        // ----- modal / secret import -----
        const importTrigger = document.getElementById('importTrigger');
        const importModal = document.getElementById('importModal');
        const cancelImport = document.getElementById('cancelImport');
        const confirmImport = document.getElementById('confirmImport');
        const excelInput = document.getElementById('excelFileInput');
        const importFeedback = document.getElementById('importFeedback');

        importTrigger.addEventListener('click', () => {
            importModal.classList.add('active');
            excelInput.value = ''; // clear previous
            importFeedback.innerText = '';
        });
        cancelImport.addEventListener('click', () => importModal.classList.remove('active'));
        window.addEventListener('click', (e) => { if (e.target === importModal) importModal.classList.remove('active'); });

        // ----- sequential SM -----
        async function updateSequentialSM() {
            try {
                const snap = await recordsCol.orderBy('timestamp', 'desc').limit(1).get();
                let next = 1;
                if (!snap.empty) {
                    const last = snap.docs[0].data().sm;
                    if (last && last.startsWith('WANB-')) {
                        const num = parseInt(last.split('-')[1], 10);
                        if (!isNaN(num)) next = num + 1;
                    }
                }
                smField.value = `WANB-${next.toString().padStart(2, '0')}`;
            } catch { smField.value = 'WANB-01'; }
        }

        function updateCalc() {
            const c = parseFloat(cfr.value) || 0, s = parseFloat(sell.value) || 0, r = parseFloat(exchange.value) || 130;
            const usd = s - c;
            marginUsd.value = usd.toFixed(2);
            marginKes.value = (usd * r).toFixed(2);
        }
        [cfr, paid, sell, exchange].forEach(el => el.addEventListener('input', updateCalc));
        calcBtn.addEventListener('click', (e) => { e.preventDefault(); updateCalc(); });

        clearBtn.addEventListener('click', async () => {
            paymentRate.value = ''; makeModel.value = ''; chassis.value = ''; cfr.value = ''; paid.value = ''; sell.value = '';
            supplier.value = 'GOONET';
            await updateSequentialSM();
            updateCalc();
        });

        saveBtn.addEventListener('click', async () => {
            const record = {
                paymentRate: paymentRate.value, sm: smField.value, supplier: supplier.value,
                makeModel: makeModel.value, chassis: chassis.value, cfr: parseFloat(cfr.value) || 0,
                paidUsd: parseFloat(paid.value) || 0, sellingPrice: parseFloat(sell.value) || 0,
                marginUsd: parseFloat(marginUsd.value) || 0, marginKes: parseFloat(marginKes.value) || 0,
                exchangeRateUsed: parseFloat(exchange.value) || 130,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            try { await recordsCol.add(record); feedback.innerText = '‚úì saved'; await updateSequentialSM(); loadSheetData(); updateOverviewAndSnapshots(); } 
            catch (err) { feedback.innerText = '‚úó error'; }
        });

        // ----- IMPORT LOGIC (secret, parses GOONET sheet) -----
        confirmImport.addEventListener('click', async () => {
            const file = excelInput.files[0];
            if (!file) { importFeedback.innerText = '‚ùå select a file'; return; }
            importFeedback.innerText = '‚è≥ processing ...';

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                // try to find sheet named "Sheet1" (or first sheet)
                const sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('sheet1')) || workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

                // find header row (look for "S/M", "SUPPLIER", "Maker & Model" etc.)
                let headerRowIndex = -1;
                for (let i = 0; i < Math.min(20, rows.length); i++) {
                    const row = rows[i];
                    if (row && row.some(cell => String(cell).includes('S/M')) && row.some(cell => String(cell).includes('SUPPLIER'))) {
                        headerRowIndex = i;
                        break;
                    }
                }
                if (headerRowIndex === -1) { importFeedback.innerText = '‚ùå could not find header row'; return; }

                const headers = rows[headerRowIndex].map(h => String(h).trim().toLowerCase().replace(/[^a-z0-9]/g, ''));
                const smIdx = headers.findIndex(h => h.includes('sm') || h.includes('sm') || h.includes('s/m'));
                const suppIdx = headers.findIndex(h => h.includes('supplier'));
                const modelIdx = headers.findIndex(h => h.includes('maker') || h.includes('make') || h.includes('model'));
                const chassisIdx = headers.findIndex(h => h.includes('chassis'));
                const cfrIdx = headers.findIndex(h => h.includes('cfr'));
                const paidIdx = headers.findIndex(h => h.includes('paid'));
                const sellIdx = headers.findIndex(h => h.includes('selling') || h.includes('sell') || h.includes('price'));

                if (smIdx === -1 || suppIdx === -1) { importFeedback.innerText = '‚ùå required columns missing'; return; }

                const records = [];
                const rateNow = parseFloat(exchange.value) || 130;
                let importCount = 0;

                for (let i = headerRowIndex + 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row || row.length < 3) continue;
                    const smVal = row[smIdx] ? String(row[smIdx]).trim() : '';
                    if (!smVal || smVal === '' || smVal.startsWith('WANB-') === false) continue; // only GOONET rows with WANB-
                    
                    const supplierVal = row[suppIdx] ? String(row[suppIdx]).trim() : 'GOONET';
                    const modelVal = row[modelIdx] ? String(row[modelIdx]).trim() : '';
                    const chassisVal = row[chassisIdx] ? String(row[chassisIdx]).trim() : '';
                    
                    let cfrVal = 0, paidVal = 0, sellVal = 0;
                    if (cfrIdx !== -1) cfrVal = parseFloat(String(row[cfrIdx]).replace(/[^0-9.-]/g, '')) || 0;
                    if (paidIdx !== -1) paidVal = parseFloat(String(row[paidIdx]).replace(/[^0-9.-]/g, '')) || 0;
                    if (sellIdx !== -1) sellVal = parseFloat(String(row[sellIdx]).replace(/[^0-9.-]/g, '')) || 0;

                    const marginUsdVal = sellVal - cfrVal;
                    const marginKesVal = marginUsdVal * rateNow;

                    // skip rows with zero CFR and zero sell (likely empty)
                    if (cfrVal === 0 && sellVal === 0) continue;

                    records.push({
                        paymentRate: '1', // default, not in sheet
                        sm: smVal,
                        supplier: supplierVal,
                        makeModel: modelVal,
                        chassis: chassisVal,
                        cfr: cfrVal,
                        paidUsd: paidVal,
                        sellingPrice: sellVal,
                        marginUsd: marginUsdVal,
                        marginKes: marginKesVal,
                        exchangeRateUsed: rateNow,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    importCount++;
                }

                if (records.length === 0) { importFeedback.innerText = '‚ö†Ô∏è no valid GOONET rows found'; return; }

                // batch commit (Firestore batches of 500)
                const batchSize = 400;
                for (let i = 0; i < records.length; i += batchSize) {
                    const batch = db.batch();
                    const chunk = records.slice(i, i + batchSize);
                    chunk.forEach(r => {
                        const docRef = recordsCol.doc(); // auto id
                        batch.set(docRef, r);
                    });
                    await batch.commit();
                }

                importFeedback.innerText = `‚úÖ imported ${records.length} records from GOONET sheet`;
                importModal.classList.remove('active');
                await updateSequentialSM(); // recalc next SM based on latest
                loadSheetData();
                updateOverviewAndSnapshots();

            } catch (err) {
                importFeedback.innerText = `‚ùå error: ${err.message}`;
            }
        });

        // ----- load data -----
        async function loadSheetData() {
            try {
                const snap = await recordsCol.orderBy('timestamp', 'desc').get();
                if (snap.empty) { sheetBody.innerHTML = '<tr><td colspan="10">no records</td></tr>'; return; }
                const rate = parseFloat(exchange.value) || 130;
                let html = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const mu = (d.sellingPrice - d.cfr).toFixed(2);
                    const mk = (mu * rate).toFixed(2);
                    html += `<tr><td>${d.paymentRate || ''}</td><td>${d.sm || ''}</td><td>${d.supplier || ''}</td><td>${d.makeModel || ''}</td><td>${d.chassis || ''}</td><td>$${d.cfr?.toFixed(2)}</td><td>$${d.paidUsd?.toFixed(2)}</td><td>$${d.sellingPrice?.toFixed(2)}</td><td>$${mu}</td><td>KES ${mk}</td></tr>`;
                });
                sheetBody.innerHTML = html;
            } catch { sheetBody.innerHTML = '<tr><td colspan="10">error loading</td></tr>'; }
        }

        async function updateOverviewAndSnapshots() {
            try {
                const snap = await recordsCol.get();
                const docs = snap.docs.map(d => d.data());
                const total = docs.length;
                const totalUsd = docs.reduce((acc, d) => acc + (d.sellingPrice - d.cfr), 0);
                const rate = parseFloat(exchange.value) || 130;
                totalVehiclesSpan.innerText = `Total: ${total}`;
                totalMarginUsdSpan.innerText = `Margin USD: $${totalUsd.toFixed(2)}`;
                totalMarginKesSpan.innerText = `Margin KES: KES ${(totalUsd * rate).toFixed(2)}`;
                let cards = '';
                snap.docs.slice(0,4).forEach(d => {
                    const dd = d.data();
                    const mu = (dd.sellingPrice - dd.cfr).toFixed(2);
                    cards += `<div class="doc-card"><h4>${dd.makeModel||''}</h4><p>SM: ${dd.sm||''} | ${dd.supplier||''}</p><p>üí∞ USD $${mu}</p></div>`;
                });
                snapshotGrid.innerHTML = cards || '<div class="doc-card">no data</div>';
            } catch (e) {}
        }

        refreshBtn.addEventListener('click', loadSheetData);
        function switchTab(tabId) {
            tabs.forEach(b => b.classList.remove('active'));
            document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');
            [tabEntry, tabSpread, tabOverview].forEach(t => t.classList.add('hidden-tab'));
            if (tabId === 'entry') { tabEntry.classList.remove('hidden-tab'); updateSequentialSM(); }
            if (tabId === 'spreadsheet') { tabSpread.classList.remove('hidden-tab'); loadSheetData(); }
            if (tabId === 'overview') { tabOverview.classList.remove('hidden-tab'); updateOverviewAndSnapshots(); }
        }
        tabs.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));

        // initialise
        updateSequentialSM().then(() => { updateCalc(); loadSheetData(); updateOverviewAndSnapshots(); });
        exchange.addEventListener('input', () => {
            updateCalc();
            if (!tabSpread.classList.contains('hidden-tab')) loadSheetData();
            if (!tabOverview.classList.contains('hidden-tab')) updateOverviewAndSnapshots();
        });

        // pdf functions (abbreviated)
        document.getElementById('downloadPdfReport').addEventListener('click', () => { alert('PDF generation uses same logic, omitted for brevity'); });
        document.getElementById('downloadSnapshotPdf').addEventListener('click', () => { alert('Snapshot PDF'); });
    })();
</script>
</body>
</html>
