<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CK Manager ¬∑ sequential ¬∑ search ¬∑ PDF</title>
    <!-- Firebase compat -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- jsPDF + autotable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        body {
            background: #0a0c10;
            display: flex;
            justify-content: center;
            padding: 2rem 1.5rem;
            color: #eef3f8;
        }
        .app-container { max-width: 1440px; width: 100%; }

        .card {
            background: #151a22;
            border-radius: 26px;
            padding: 2rem 2.2rem;
            border: 1px solid #2c3542;
            box-shadow: 0 16px 30px -10px black;
        }

        .tabs {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }
        .tab-btn {
            background: transparent;
            border: 1px solid #384458;
            padding: 0.7rem 2rem;
            border-radius: 40px;
            font-weight: 500;
            color: #b7c9e0;
            cursor: pointer;
            transition: 0.15s;
        }
        .tab-btn.active {
            background: #2c402c;
            border-color: #6fa06f;
            color: #e2f0e2;
        }
        .tab-btn:hover { border-color: #7fa07f; }

        .secret-import-trigger {
            display: inline-block;
            cursor: pointer;
            color: #4a5f4a;
            font-size: 1.8rem;
            line-height: 1;
            transition: 0.2s;
            margin-left: 1rem;
        }
        .secret-import-trigger:hover { color: #8fbc8f; transform: scale(1.05); }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(3px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-card {
            background: #1e262f;
            border-radius: 36px;
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            border: 1px solid #5f8b5f;
            box-shadow: 0 30px 50px #00000080;
        }
        .modal-card h3 { color: #c6f0c6; margin-bottom: 1.5rem; font-weight: 400; }
        .modal-card input[type="file"] {
            background: #0f171f;
            border: 1px solid #4e6d5e;
            border-radius: 30px;
            padding: 1rem;
            width: 100%;
            color: white;
            margin: 1rem 0;
        }
        .modal-actions { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; }
        .btn-secret { background: #2e452e; border: 1px solid #7ba07b; color: white; }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1.2rem 2rem;
            margin-bottom: 1.6rem;
            align-items: flex-end;
        }
        .field-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
            flex: 1 0 140px;
        }
        .field-group label {
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 500;
            color: #99aac2;
            margin-bottom: 0.25rem;
        }
        .field-group input, .field-group select {
            background: #0f141d;
            border: 1px solid #2e3745;
            border-radius: 16px;
            padding: 0.85rem 1.2rem;
            font-size: 0.95rem;
            color: #f0f7ff;
        }
        .field-group select {
            appearance: none;
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2399b3cc'><polyline points='6 9 12 15 18 9'/></svg>");
            background-repeat: no-repeat;
            background-position: right 1rem center;
        }
        .field-group input:focus, .field-group select:focus {
            border-color: #7dae7d;
            box-shadow: 0 0 0 2px #2a4a2a80;
            outline: none;
        }
        .field-group input[readonly] { background: #1b232f; color: #cbd6e6; }

        .exchange-rate-row {
            background: #1b2620;
            border: 1px solid #3d5841;
            border-radius: 60px;
            padding: 0.8rem 2rem;
            display: flex;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
            margin-bottom: 2.2rem;
        }
        .rate-label { font-weight: 500; color: #bde1bd; }
        .rate-input {
            width: 130px;
            background: #0f1a12;
            border: 1px solid #578057;
            border-radius: 30px;
            padding: 0.6rem 1.2rem;
            color: white;
        }

        .btn {
            background: #262f3b;
            border: 1px solid #43536a;
            padding: 0.8rem 2rem;
            border-radius: 30px;
            font-weight: 500;
            cursor: pointer;
            color: #dde9f5;
            transition: 0.15s;
        }
        .btn-primary {
            background: #2d442d;
            border-color: #70a070;
            color: #f0fff0;
        }
        .btn-primary:hover { background: #3e603e; }
        .btn-outline {
            background: transparent;
            border-color: #527252;
            color: #c6e2c6;
        }
        .btn-outline:hover { background: #1f311f; }

        /* search bar */
        .search-section {
            background: #1b2320;
            border-radius: 40px;
            padding: 1.2rem 2rem;
            margin-bottom: 2rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1.5rem;
            border: 1px solid #3d5841;
        }
        .search-input {
            flex: 2;
            min-width: 250px;
            background: #0f171f;
            border: 1px solid #4e6d5e;
            border-radius: 30px;
            padding: 0.8rem 1.5rem;
            color: white;
            font-size: 0.95rem;
        }
        .range-input {
            width: 100px;
            background: #0f171f;
            border: 1px solid #4e6d5e;
            border-radius: 30px;
            padding: 0.8rem 1rem;
            color: white;
            text-align: center;
        }
        .search-label { color: #bde1bd; font-weight: 500; }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 20px;
            border: 1px solid #2f3847;
            background: #121721;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            min-width: 1300px;
            color: #e5eef7;
        }
        th {
            background: #212b38;
            padding: 1rem 0.8rem;
            font-weight: 500;
            border-bottom: 1px solid #557255;
        }
        td { padding: 0.9rem 0.8rem; border-bottom: 1px solid #28313e; }

        .overview-stats {
            display: flex;
            gap: 2rem;
            background: #1e2a20;
            border: 1px solid #4e6e53;
            border-radius: 48px;
            padding: 1.5rem 2.8rem;
            margin-bottom: 2.5rem;
            flex-wrap: wrap;
        }
        .stat-item {
            background: #121f15;
            border: 1px solid #5b875b;
            border-radius: 40px;
            padding: 0.7rem 2.2rem;
            font-weight: 500;
            color: #daf0da;
        }

        .print-docs-area {
            background: #1e2820;
            border-radius: 32px;
            padding: 2rem;
            border: 1px solid #557755;
        }
        .doc-thumb-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            margin-top: 2rem;
        }
        .doc-card {
            background: #172117;
            border: 1px solid #628062;
            border-radius: 24px;
            padding: 1.5rem;
            width: 260px;
            color: #daf0da;
        }
        .doc-card h4 { color: #c9f0c9; font-weight: 500; }

        .hidden-tab { display: none; }
        #saveFeedback, #importFeedback { margin-top: 1rem; color: #b3e0b3; }
        .search-highlight { background: #3c6e3c; font-weight: bold; }
    </style>
</head>
<body>
<div class="app-container">
    <div style="display: flex; align-items: center; margin-bottom: 2rem;">
        <h2 style="font-weight: 400; color: #eaf3ea;"><span style="color: #9fda9f;">CK</span> manager ¬∑ sequential WANB</h2>
        <span class="secret-import-trigger" id="importTrigger" title="import data">‚ö°</span>
    </div>

    <div class="tabs" id="tabNavigation">
        <button class="tab-btn active" data-tab="entry">‚ûï entry</button>
        <button class="tab-btn" data-tab="spreadsheet">üìã spreadsheet + search</button>
        <button class="tab-btn" data-tab="overview">üìä overview & pdf</button>
    </div>

    <!-- import modal -->
    <div class="modal" id="importModal">
        <div class="modal-card">
            <h3>üîí secure import</h3>
            <p style="color:#b8d5b8; margin-bottom:1.5rem;">upload excel file (.xlsx) ‚Äî GOONET sheet</p>
            <input type="file" id="excelFileInput" accept=".xlsx, .xls, .csv">
            <div class="modal-actions">
                <button class="btn btn-outline" id="cancelImport">cancel</button>
                <button class="btn btn-secret" id="confirmImport">import & save</button>
            </div>
            <div id="importFeedback"></div>
        </div>
    </div>

    <!-- entry tab -->
    <div id="tab-entry" class="tab-content card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="font-weight: 400; color: #d2f0d2;">new record ¬∑ SM seq WANB‚Äëxx</h3>
            <span class="rate-label">‚ö° exchange (default 130)</span>
        </div>
        <div class="exchange-rate-row">
            <span class="rate-label">üí± rate</span>
            <input type="number" id="exchangeRateInput" class="rate-input" value="130.00" step="0.5" min="0">
        </div>
        <div class="form-row">
            <div class="field-group"><label>Payment rate</label><input type="text" id="paymentRate" value="10.5%"></div>
            <div class="field-group"><label>SM (seq.)</label><input type="text" id="sm" readonly placeholder="WANB-01" value="WANB-01"></div>
            <div class="field-group"><label>Supplier</label>
                <select id="supplier"><option value="GOONET">GOONET</option><option value="ENHANCE">ENHANCE</option><option value="TTC">TTC</option><option value="OTTOS">OTTOS</option><option value="GLOBAL">GLOBAL</option></select>
            </div>
            <div class="field-group"><label>Make & Model</label><input type="text" id="makeModel" value="Toyota Hilux"></div>
        </div>
        <div class="form-row">
            <div class="field-group"><label>Chassis No</label><input type="text" id="chassis" value="MR0EX3CJ50J123456"></div>
            <div class="field-group"><label>CFR (USD)</label><input type="number" id="cfr" value="25200" step="100"></div>
            <div class="field-group"><label>Paid USD</label><input type="number" id="paidUsd" value="10200" step="100"></div>
            <div class="field-group"><label>Selling Price USD</label><input type="number" id="sellingPrice" value="31500" step="100"></div>
        </div>
        <div class="form-row">
            <div class="field-group"><label>üí∞ Margin USD</label><input type="number" id="marginUsd" readonly></div>
            <div class="field-group"><label>üí∞ Margin KSH</label><input type="number" id="marginKes" readonly></div>
        </div>
        <div style="display: flex; gap: 1.2rem; flex-wrap: wrap;">
            <button class="btn btn-primary" id="calculateBtn">‚ü≤ calculate</button>
            <button class="btn btn-primary" id="saveToFirebaseBtn">üíæ save to firebase</button>
            <button class="btn btn-outline" id="clearFormBtn">clear</button>
        </div>
        <p id="saveFeedback"></p>
    </div>

    <!-- spreadsheet with search & range -->
    <div id="tab-spreadsheet" class="tab-content card hidden-tab">
        <div style="margin-bottom: 1.5rem;">
            <h3 style="color:#d2f0d2;">üîç search & range filter</h3>
        </div>
        <div class="search-section">
            <span class="search-label">üîé search:</span>
            <input type="text" id="searchInput" class="search-input" placeholder="SM, model, chassis, supplier...">
            
            <span class="search-label">from:</span>
            <input type="text" id="rangeFrom" class="range-input" placeholder="WANB-01">
            <span class="search-label">to:</span>
            <input type="text" id="rangeTo" class="range-input" placeholder="WANB-50">
            
            <button class="btn btn-outline" id="applySearchBtn">apply</button>
            <button class="btn btn-outline" id="clearSearchBtn">clear</button>
            <button class="btn btn-primary" id="downloadRangePdf">üì• download range PDF</button>
        </div>

        <div class="table-wrapper">
            <table>
                <thead><tr><th>Pay rate</th><th>SM</th><th>Supplier</th><th>Make/model</th><th>Chassis</th><th>CFR</th><th>Paid USD</th><th>Sell price</th><th>Margin USD</th><th>Margin KES</th></tr></thead>
                <tbody id="sheetBody"><tr><td colspan="10" style="text-align:center;">loading...</td></tr></tbody>
            </table>
        </div>
        <div style="margin-top: 1rem; color: #9bb89b;" id="resultCount"></div>
    </div>

    <!-- overview & PDF (sequential) -->
    <div id="tab-overview" class="tab-content card hidden-tab">
        <div class="overview-stats">
            <div class="stat-item" id="totalVehiclesStat">Total: 0</div>
            <div class="stat-item" id="totalMarginUsdStat">Margin USD: 0</div>
            <div class="stat-item" id="totalMarginKesStat">Margin KES: 0</div>
        </div>
        <div class="print-docs-area">
            <h3 style="color:#d2f0d2;">üñ®Ô∏è PDF reports (sequential WANB order)</h3>
            <div style="display: flex; gap: 2rem; margin: 2rem 0; flex-wrap: wrap;">
                <button class="btn btn-primary" id="downloadPdfReport">üì• full report (WANB order)</button>
                <button class="btn btn-outline" id="downloadSnapshotPdf">üì∏ snapshot PDF</button>
            </div>
            <div class="doc-thumb-grid" id="snapshotGrid"></div>
        </div>
    </div>
</div>

<script>
    (function() {
        // Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCuUKCxYx0jYKqWOQaN82K5zFGlQsKQsK0",
            authDomain: "ck-manager-1abdc.firebaseapp.com",
            projectId: "ck-manager-1abdc",
            storageBucket: "ck-manager-1abdc.firebasestorage.app",
            messagingSenderId: "890017473158",
            appId: "1:890017473158:web:528e1eebc4b67bd54ca707"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const recordsCol = db.collection('vehicleRecords');

        // DOM elements with null checks
        const tabs = document.querySelectorAll('.tab-btn');
        const tabEntry = document.getElementById('tab-entry');
        const tabSpread = document.getElementById('tab-spreadsheet');
        const tabOverview = document.getElementById('tab-overview');
        const smField = document.getElementById('sm');
        const supplier = document.getElementById('supplier');
        const paymentRate = document.getElementById('paymentRate');
        const makeModel = document.getElementById('makeModel');
        const chassis = document.getElementById('chassis');
        const cfr = document.getElementById('cfr');
        const paid = document.getElementById('paidUsd');
        const sell = document.getElementById('sellingPrice');
        const marginUsd = document.getElementById('marginUsd');
        const marginKes = document.getElementById('marginKes');
        const exchange = document.getElementById('exchangeRateInput');
        const saveBtn = document.getElementById('saveToFirebaseBtn');
        const clearBtn = document.getElementById('clearFormBtn');
        const calcBtn = document.getElementById('calculateBtn');
        const sheetBody = document.getElementById('sheetBody');
        const snapshotGrid = document.getElementById('snapshotGrid');
        const totalVehiclesSpan = document.getElementById('totalVehiclesStat');
        const totalMarginUsdSpan = document.getElementById('totalMarginUsdStat');
        const totalMarginKesSpan = document.getElementById('totalMarginKesStat');
        const feedback = document.getElementById('saveFeedback');

        // Search elements
        const searchInput = document.getElementById('searchInput');
        const rangeFrom = document.getElementById('rangeFrom');
        const rangeTo = document.getElementById('rangeTo');
        const applySearchBtn = document.getElementById('applySearchBtn');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const downloadRangeBtn = document.getElementById('downloadRangePdf');
        const resultCount = document.getElementById('resultCount');

        // PDF buttons
        const downloadPdfBtn = document.getElementById('downloadPdfReport');
        const downloadSnapshotBtn = document.getElementById('downloadSnapshotPdf');

        // Import modal elements
        const importTrigger = document.getElementById('importTrigger');
        const importModal = document.getElementById('importModal');
        const cancelImport = document.getElementById('cancelImport');
        const confirmImport = document.getElementById('confirmImport');
        const excelInput = document.getElementById('excelFileInput');
        const importFeedback = document.getElementById('importFeedback');

        // Helper function to extract number from WANB-XX
        function getSmNumber(sm) {
            if (!sm || !sm.startsWith('WANB-')) return 0;
            const num = parseInt(sm.split('-')[1], 10);
            return isNaN(num) ? 0 : num;
        }

        // Sort records by SM numerically
        function sortRecordsBySm(records) {
            return records.sort((a, b) => {
                const numA = getSmNumber(a.sm);
                const numB = getSmNumber(b.sm);
                return numA - numB;
            });
        }

        // Set default exchange to 130
        if (exchange) exchange.value = '130.00';

        // Import modal functionality
        if (importTrigger && importModal) {
            importTrigger.addEventListener('click', () => {
                importModal.classList.add('active');
                if (excelInput) excelInput.value = '';
                if (importFeedback) importFeedback.innerText = '';
            });
        }
        
        if (cancelImport && importModal) {
            cancelImport.addEventListener('click', () => importModal.classList.remove('active'));
        }
        
        window.addEventListener('click', (e) => {
            if (importModal && e.target === importModal) importModal.classList.remove('active');
        });

        // ----- sequential SM (based on WANB number) -----
        async function getNextSM() {
            try {
                const snap = await recordsCol.get();
                let maxNum = 0;
                snap.forEach(doc => {
                    const s = doc.data().sm;
                    const num = getSmNumber(s);
                    if (num > maxNum) maxNum = num;
                });
                return `WANB-${(maxNum + 1).toString().padStart(2, '0')}`;
            } catch {
                return 'WANB-01';
            }
        }
        
        async function updateSequentialSM() {
            if (smField) smField.value = await getNextSM();
        }

        function updateCalc() {
            if (!cfr || !sell || !exchange || !marginUsd || !marginKes) return;
            const c = parseFloat(cfr.value) || 0;
            const s = parseFloat(sell.value) || 0;
            const r = parseFloat(exchange.value) || 130;
            const usd = s - c;
            marginUsd.value = usd.toFixed(2);
            marginKes.value = (usd * r).toFixed(2);
        }
        
        if (cfr && paid && sell && exchange) {
            [cfr, paid, sell, exchange].forEach(el => {
                if (el) el.addEventListener('input', updateCalc);
            });
        }
        
        if (calcBtn) {
            calcBtn.addEventListener('click', (e) => { 
                e.preventDefault(); 
                updateCalc(); 
            });
        }

        if (clearBtn) {
            clearBtn.addEventListener('click', async () => {
                if (paymentRate) paymentRate.value = '';
                if (makeModel) makeModel.value = '';
                if (chassis) chassis.value = '';
                if (cfr) cfr.value = '';
                if (paid) paid.value = '';
                if (sell) sell.value = '';
                if (supplier) supplier.value = 'GOONET';
                await updateSequentialSM();
                updateCalc();
            });
        }

        if (saveBtn) {
            saveBtn.addEventListener('click', async () => {
                if (!smField || !supplier || !makeModel || !chassis || !cfr || !paid || !sell || !marginUsd || !marginKes || !exchange) return;
                
                const record = {
                    paymentRate: paymentRate ? paymentRate.value : '',
                    sm: smField.value,
                    supplier: supplier.value,
                    makeModel: makeModel.value,
                    chassis: chassis.value,
                    cfr: parseFloat(cfr.value) || 0,
                    paidUsd: parseFloat(paid.value) || 0,
                    sellingPrice: parseFloat(sell.value) || 0,
                    marginUsd: parseFloat(marginUsd.value) || 0,
                    marginKes: parseFloat(marginKes.value) || 0,
                    exchangeRateUsed: parseFloat(exchange.value) || 130,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                try { 
                    await recordsCol.add(record); 
                    if (feedback) feedback.innerText = '‚úì saved'; 
                    await updateSequentialSM(); 
                    loadSheetData(); 
                    updateOverviewAndSnapshots(); 
                } catch (err) { 
                    if (feedback) feedback.innerText = '‚úó error'; 
                }
            });
        }

        // ----- IMPORT -----
        if (confirmImport) {
            confirmImport.addEventListener('click', async () => {
                const file = excelInput ? excelInput.files[0] : null;
                if (!file) { 
                    if (importFeedback) importFeedback.innerText = '‚ùå select a file'; 
                    return; 
                }
                if (importFeedback) importFeedback.innerText = '‚è≥ processing ...';

                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('sheet1')) || workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

                    let headerRowIndex = -1;
                    for (let i = 0; i < Math.min(20, rows.length); i++) {
                        const row = rows[i];
                        if (row && row.some(cell => String(cell).includes('S/M')) && row.some(cell => String(cell).includes('SUPPLIER'))) {
                            headerRowIndex = i;
                            break;
                        }
                    }
                    if (headerRowIndex === -1) { 
                        if (importFeedback) importFeedback.innerText = '‚ùå could not find header row'; 
                        return; 
                    }

                    const headers = rows[headerRowIndex].map(h => String(h).trim().toLowerCase().replace(/[^a-z0-9]/g, ''));
                    const smIdx = headers.findIndex(h => h.includes('sm') || h.includes('s/m'));
                    const suppIdx = headers.findIndex(h => h.includes('supplier'));
                    const modelIdx = headers.findIndex(h => h.includes('maker') || h.includes('make') || h.includes('model'));
                    const chassisIdx = headers.findIndex(h => h.includes('chassis'));
                    const cfrIdx = headers.findIndex(h => h.includes('cfr'));
                    const paidIdx = headers.findIndex(h => h.includes('paid'));
                    const sellIdx = headers.findIndex(h => h.includes('selling') || h.includes('sell') || h.includes('price'));

                    if (smIdx === -1 || suppIdx === -1) { 
                        if (importFeedback) importFeedback.innerText = '‚ùå required columns missing'; 
                        return; 
                    }

                    const records = [];
                    const rateNow = 130;
                    
                    for (let i = headerRowIndex + 1; i < rows.length; i++) {
                        const row = rows[i];
                        if (!row || row.length < 3) continue;
                        const smVal = row[smIdx] ? String(row[smIdx]).trim() : '';
                        if (!smVal || smVal === '' || !smVal.startsWith('WANB-')) continue;

                        const supplierVal = row[suppIdx] ? String(row[suppIdx]).trim() : 'GOONET';
                        const modelVal = row[modelIdx] ? String(row[modelIdx]).trim() : '';
                        const chassisVal = row[chassisIdx] ? String(row[chassisIdx]).trim() : '';

                        let cfrVal = 0, paidVal = 0, sellVal = 0;
                        if (cfrIdx !== -1) cfrVal = parseFloat(String(row[cfrIdx]).replace(/[^0-9.-]/g, '')) || 0;
                        if (paidIdx !== -1) paidVal = parseFloat(String(row[paidIdx]).replace(/[^0-9.-]/g, '')) || 0;
                        if (sellIdx !== -1) sellVal = parseFloat(String(row[sellIdx]).replace(/[^0-9.-]/g, '')) || 0;

                        const marginUsdVal = sellVal - cfrVal;
                        const marginKesVal = marginUsdVal * rateNow;

                        if (cfrVal === 0 && sellVal === 0) continue;

                        records.push({
                            paymentRate: '1',
                            sm: smVal,
                            supplier: supplierVal,
                            makeModel: modelVal,
                            chassis: chassisVal,
                            cfr: cfrVal,
                            paidUsd: paidVal,
                            sellingPrice: sellVal,
                            marginUsd: marginUsdVal,
                            marginKes: marginKesVal,
                            exchangeRateUsed: rateNow,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }

                    if (records.length === 0) { 
                        if (importFeedback) importFeedback.innerText = '‚ö†Ô∏è no valid GOONET rows found'; 
                        return; 
                    }

                    const batchSize = 400;
                    for (let i = 0; i < records.length; i += batchSize) {
                        const batch = db.batch();
                        const chunk = records.slice(i, i + batchSize);
                        chunk.forEach(r => {
                            const docRef = recordsCol.doc();
                            batch.set(docRef, r);
                        });
                        await batch.commit();
                    }

                    if (importFeedback) importFeedback.innerText = `‚úÖ imported ${records.length} records`;
                    if (importModal) importModal.classList.remove('active');
                    await updateSequentialSM();
                    loadSheetData();
                    updateOverviewAndSnapshots();

                } catch (err) {
                    if (importFeedback) importFeedback.innerText = `‚ùå error: ${err.message}`;
                }
            });
        }

        // ----- load spreadsheet with search/range -----
        let allRecords = [];

        async function loadSheetData() {
            try {
                const snap = await recordsCol.get();
                allRecords = [];
                snap.forEach(doc => allRecords.push({ id: doc.id, ...doc.data() }));
                // Sort numerically
                allRecords = sortRecordsBySm(allRecords);
                if (typeof applySearchFilter === 'function') applySearchFilter();
            } catch (err) { 
                if (sheetBody) sheetBody.innerHTML = `<tr><td colspan="10" style="color:#f7b5b5;">error: ${err.message}</td></tr>`; 
            }
        }

        function applySearchFilter() {
            if (!sheetBody) return;
            
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
            const fromVal = rangeFrom ? rangeFrom.value.trim().toUpperCase() : '';
            const toVal = rangeTo ? rangeTo.value.trim().toUpperCase() : '';
            const rate = parseFloat(exchange ? exchange.value : '130') || 130;

            // First filter the records
            let filtered = allRecords.filter(rec => {
                if (fromVal || toVal) {
                    const sm = rec.sm || '';
                    const smNum = getSmNumber(sm);
                    const fromNum = fromVal ? getSmNumber(fromVal) : 0;
                    const toNum = toVal ? getSmNumber(toVal) : Infinity;
                    
                    if (fromVal && smNum < fromNum) return false;
                    if (toVal && smNum > toNum) return false;
                }
                if (searchTerm) {
                    const haystack = `${rec.sm} ${rec.makeModel} ${rec.chassis} ${rec.supplier}`.toLowerCase();
                    return haystack.includes(searchTerm);
                }
                return true;
            });

            // Then sort the filtered results numerically
            filtered = sortRecordsBySm(filtered);
            
            renderTable(filtered, rate);
            if (resultCount) resultCount.innerText = `showing ${filtered.length} of ${allRecords.length} records`;
        }

        function renderTable(records, rate) {
            if (!sheetBody) return;
            
            if (records.length === 0) {
                sheetBody.innerHTML = '<tr><td colspan="10" style="text-align:center;">no matching records</td></tr>';
                return;
            }
            let html = '';
            records.forEach(d => {
                const mu = (d.sellingPrice - d.cfr).toFixed(2);
                const mk = (mu * rate).toFixed(2);
                html += `<tr>
                    <td>${d.paymentRate || ''}</td>
                    <td>${d.sm || ''}</td>
                    <td>${d.supplier || ''}</td>
                    <td>${d.makeModel || ''}</td>
                    <td>${d.chassis || ''}</td>
                    <td>$${d.cfr?.toFixed(2)}</td>
                    <td>$${d.paidUsd?.toFixed(2)}</td>
                    <td>$${d.sellingPrice?.toFixed(2)}</td>
                    <td>$${mu}</td>
                    <td>KES ${mk}</td>
                </tr>`;
            });
            sheetBody.innerHTML = html;
        }

        // Search event listeners
        if (applySearchBtn) applySearchBtn.addEventListener('click', applySearchFilter);
        if (clearSearchBtn) {
            clearSearchBtn.addEventListener('click', () => {
                if (searchInput) searchInput.value = '';
                if (rangeFrom) rangeFrom.value = '';
                if (rangeTo) rangeTo.value = '';
                applySearchFilter();
            });
        }

        // ----- overview & snapshots -----
        async function updateOverviewAndSnapshots() {
            try {
                const snap = await recordsCol.get();
                let docs = [];
                snap.forEach(doc => docs.push(doc.data()));
                // Sort numerically for display
                docs = sortRecordsBySm(docs);
                
                const total = docs.length;
                const totalUsd = docs.reduce((acc, d) => acc + (d.sellingPrice - d.cfr), 0);
                const rate = parseFloat(exchange ? exchange.value : '130') || 130;
                
                if (totalVehiclesSpan) totalVehiclesSpan.innerText = `Total vehicles: ${total}`;
                if (totalMarginUsdSpan) totalMarginUsdSpan.innerText = `Total margin USD: $${totalUsd.toFixed(2)}`;
                if (totalMarginKesSpan) totalMarginKesSpan.innerText = `Total margin KES: KES ${(totalUsd * rate).toFixed(2)}`;

                // Get first 4 for snapshot (after sorting)
                let cards = '';
                docs.slice(0, 4).forEach(d => {
                    const mu = (d.sellingPrice - d.cfr).toFixed(2);
                    cards += `<div class="doc-card">
                        <h4>${d.makeModel || '‚Äî'}</h4>
                        <p>SM: ${d.sm || ''} | ${d.supplier || ''}</p>
                        <p>üí∞ USD margin: $${mu}</p>
                        <p>üîß ${d.chassis ? d.chassis.substring(0, 12)+'‚Ä¶' : ''}</p>
                    </div>`;
                });
                if (snapshotGrid) snapshotGrid.innerHTML = cards || '<div class="doc-card">no data</div>';
            } catch (e) {}
        }

        // ----- PDF generation (with numerical sorting) -----
        function generateFullPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            doc.setFontSize(16);
            doc.text('CK Manager - Complete Vehicle Report (WANB order)', 14, 15);
            doc.setFontSize(9);
            doc.text(`Generated: ${new Date().toLocaleString()} | Exchange rate: ${exchange ? exchange.value : '130'} KES/USD`, 14, 22);

            recordsCol.get().then(snap => {
                let docs = [];
                snap.forEach(doc => docs.push(doc.data()));
                // Sort numerically
                docs = sortRecordsBySm(docs);
                
                const data = [];
                docs.forEach(d => {
                    const mu = (d.sellingPrice - d.cfr).toFixed(2);
                    const rate = parseFloat(exchange ? exchange.value : '130') || 130;
                    const mk = (mu * rate).toFixed(2);
                    data.push([
                        d.paymentRate || '', d.sm || '', d.supplier || '', d.makeModel || '', d.chassis || '',
                        `$${d.cfr?.toFixed(2)}`, `$${d.paidUsd?.toFixed(2)}`, `$${d.sellingPrice?.toFixed(2)}`,
                        `$${mu}`, `KES ${mk}`
                    ]);
                });
                doc.autoTable({
                    head: [['Pay rate','SM','Supplier','Make/Model','Chassis','CFR','Paid','Sell','Margin USD','Margin KES']],
                    body: data,
                    startY: 30,
                    styles: { fontSize: 8, cellPadding: 3, textColor: [30,40,50] },
                    headStyles: { fillColor: [70, 90, 70], textColor: [240,255,240] },
                });
                doc.save('ck_manager_full_sequential.pdf');
            }).catch(err => alert('PDF error: ' + err));
        }

        function generateSnapshotPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.setTextColor(40, 80, 40);
            doc.text('CK Manager ¬∑ Vehicle Snapshot', 14, 18);
            doc.setFontSize(9);
            doc.text(`Exchange rate: ${exchange ? exchange.value : '130'} KES/USD ‚Äî ${new Date().toLocaleDateString()}`, 14, 26);

            recordsCol.get().then(snap => {
                let docs = [];
                snap.forEach(doc => docs.push(doc.data()));
                // Sort numerically and take first 6
                docs = sortRecordsBySm(docs).slice(0, 6);
                
                let y = 38;
                docs.forEach((d) => {
                    const mu = (d.sellingPrice - d.cfr).toFixed(2);
                    const rate = parseFloat(exchange ? exchange.value : '130') || 130;
                    const mk = (mu * rate).toFixed(2);
                    if (y > 260) { doc.addPage(); y = 20; }

                    doc.setFillColor(235, 245, 235);
                    doc.roundedRect(14, y-4, 180, 40, 4, 4, 'F');
                    doc.setTextColor(20, 60, 20);
                    doc.text(`${d.makeModel || 'Vehicle'} | ${d.supplier || ''}`, 18, y+2);
                    doc.setTextColor(60, 60, 60);
                    doc.text(`SM: ${d.sm || ''}  |  ${d.chassis ? d.chassis.substring(0,14) : ''}`, 18, y+10);
                    doc.text(`CFR $${d.cfr?.toFixed(2)}  |  Sell $${d.sellingPrice?.toFixed(2)}`, 18, y+18);
                    doc.text(`Margin USD: $${mu}  |  Margin KES: ${mk}`, 18, y+28);
                    y += 48;
                });
                doc.save('ck_snapshot_sequential.pdf');
            }).catch(err => alert('Snapshot error: ' + err));
        }

        function downloadRangePdf() {
            if (!allRecords.length) {
                alert('No records available');
                return;
            }
            
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
            const fromVal = rangeFrom ? rangeFrom.value.trim().toUpperCase() : '';
            const toVal = rangeTo ? rangeTo.value.trim().toUpperCase() : '';
            const rate = parseFloat(exchange ? exchange.value : '130') || 130;

            let filtered = allRecords.filter(rec => {
                if (fromVal || toVal) {
                    const sm = rec.sm || '';
                    const smNum = getSmNumber(sm);
                    const fromNum = fromVal ? getSmNumber(fromVal) : 0;
                    const toNum = toVal ? getSmNumber(toVal) : Infinity;
                    
                    if (fromVal && smNum < fromNum) return false;
                    if (toVal && smNum > toNum) return false;
                }
                if (searchTerm) {
                    const haystack = `${rec.sm} ${rec.makeModel} ${rec.chassis} ${rec.supplier}`.toLowerCase();
                    return haystack.includes(searchTerm);
                }
                return true;
            });

            if (filtered.length === 0) { alert('No records match the current filter'); return; }
            
            // Sort numerically
            filtered = sortRecordsBySm(filtered);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            doc.setFontSize(16);
            doc.text('CK Manager - Filtered Range Report', 14, 15);
            doc.setFontSize(9);
            let rangeText = `Range: ${fromVal || 'START'} to ${toVal || 'END'} | Search: "${searchInput ? searchInput.value : ''}"`;
            doc.text(rangeText, 14, 22);

            const data = filtered.map(d => {
                const mu = (d.sellingPrice - d.cfr).toFixed(2);
                const mk = (mu * rate).toFixed(2);
                return [
                    d.paymentRate || '', d.sm || '', d.supplier || '', d.makeModel || '', d.chassis || '',
                    `$${d.cfr?.toFixed(2)}`, `$${d.paidUsd?.toFixed(2)}`, `$${d.sellingPrice?.toFixed(2)}`,
                    `$${mu}`, `KES ${mk}`
                ];
            });

            doc.autoTable({
                head: [['Pay rate','SM','Supplier','Make/Model','Chassis','CFR','Paid','Sell','Margin USD','Margin KES']],
                body: data,
                startY: 30,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [70, 90, 70] }
            });
            doc.save('ck_filtered_range.pdf');
        }

        if (downloadPdfBtn) downloadPdfBtn.addEventListener('click', generateFullPdf);
        if (downloadSnapshotBtn) downloadSnapshotBtn.addEventListener('click', generateSnapshotPdf);
        if (downloadRangeBtn) downloadRangeBtn.addEventListener('click', downloadRangePdf);

        // Tab switching
        function switchTab(tabId) {
            tabs.forEach(b => b.classList.remove('active'));
            const activeTab = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
            if (activeTab) activeTab.classList.add('active');
            
            if (tabEntry) tabEntry.classList.add('hidden-tab');
            if (tabSpread) tabSpread.classList.add('hidden-tab');
            if (tabOverview) tabOverview.classList.add('hidden-tab');
            
            if (tabId === 'entry' && tabEntry) { 
                tabEntry.classList.remove('hidden-tab'); 
                updateSequentialSM(); 
            }
            if (tabId === 'spreadsheet' && tabSpread) { 
                tabSpread.classList.remove('hidden-tab'); 
                loadSheetData(); 
            }
            if (tabId === 'overview' && tabOverview) { 
                tabOverview.classList.remove('hidden-tab'); 
                updateOverviewAndSnapshots(); 
            }
        }
        
        tabs.forEach(btn => {
            btn.addEventListener('click', () => switchTab(btn.dataset.tab));
        });

        // Initialize
        updateSequentialSM().then(() => { 
            updateCalc(); 
            loadSheetData(); 
            updateOverviewAndSnapshots(); 
        });

        if (exchange) {
            exchange.addEventListener('input', () => {
                updateCalc();
                if (tabSpread && !tabSpread.classList.contains('hidden-tab')) applySearchFilter();
                if (tabOverview && !tabOverview.classList.contains('hidden-tab')) updateOverviewAndSnapshots();
            });
        }
    })();
</script>
</body>
</html>
